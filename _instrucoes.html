<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo 13: Projeto Prático em OO (Devsbook)</title>
</head>
<body>
<pre>
    Módulo 13: Projeto Prático em OO (Devsbook)
    
    63 aulas
    #1: Explicando o projeto
    #2: Idealização do Banco de Dados (1/2)

        utf8mb4_general_ci

        - users
        -- id
        -- email
        -- password
        -- name
        -- birthdate
        -- city
        -- work
        -- avatar
        -- cover
        -- token

            Depois de fazer o login precisa de uma forma de 
            identificar que ainda está logado. Não é legal armazenar email
            e senha do user para verificar uma sessao ou cookie que ele
            é ele e está logado.
        
            melhor é um token, ou seja, o user apos fazer o login gera-se
            um hash aleatorio então pega essa combinação e salva no banco de dados
            associado com esse usuario
        
            entao pega esse hash e salve em um cookie/sessao, enfim, em um lugar
            associado ao navegador para que toda vez q ele entrar em uma pagina
            e se ela precisar ver se o user esta logado para ter acesso entao pega
            esse token e verifica se tem algum user com esse token no BD. é uma 
            forma facil/simples de idetificar sem precisar guardar senha/email em
            outros locais que nao seja o nosso proprio banco de dados
    
        - userrelations (relacao entre os usuarios)
        -- id 
        -- user_from
        -- user_to

        - posts 
        -- id 
        -- id_user
        -- type (text, foto, video, audio)
        -- created_at
        -- body 
        -- image
        -- like_count 
        
            manter a contagem duplicada para sistemas muito grandes
            pra se livrar de uma consulta, em sistemas grandes

        - postcomments 
        -- id 
        -- id_post (o comentario tem que estar associado a um post)
        -- id_user
        -- created_at
        -- body

        - postlikes *

            (qtos like o post teve e se eu enqto usuario dei like ou nao)
            (nao precisamos apenas da quantidade de likes, precisamos tb de quem 
            fez o post ou uma lista de pessoas, por isso essa tabela para armazenar
            apenas os likes)
            (em sistemas muitos grandes para nao fazer tantas solicitacoes no BD
            mantem-se a informacao duplicada criando o LIKE_COUNT na tabela de posts,
            isso é para facilitar na hora de consultar as informacoes)

        -- id
        -- id_post 
        -- id_user
        -- created_at


        --x--
        o sistema so funciona se o user estiver logado
        a primeira coisa é detectar se o user esta logado
        se estiver logado mantem na pagina index, senao manda para pagina login

        criar 
            processo de login
            processo de cadastro

        fazer processo p ver se o user está logado
        criar model especifico para autenticacao
        Auth.php class Auth

    #3: Idealização do Banco de Dados (2/2)
    #4: Criação do banco de dados

        devsbook_mod13_220622
        http://localhost:8888/phpMyAdmin/db_structure.php?server=1&db=devsbook_mod13_220622

    #5: Criando a base
        $base = 'http://localhost:8888/b7-review-php/mod13-OO-Devsbook/';
        
        $db_name = 'devsbook_mod13_220622';
        $db_host = 'localhost';
        $db_user = 'root';
        $db_pass = 'root';
        
        $pdo = new PDO('mysql:dbname='.$db_name.';host='.$db_host, $db_user, $db_pass);

    #6: Detectando Login (1/2)

        verificar se tem sessao
        se a sessao tem um token
            se nao tiver token, manda para o login

        verificar se o token da sessao pertence a algum user
        se pertencer entao está logado com aquele user 
        senao voltar para o inicio / login

        User.php
            class User{
                public $id; ...
            }
            interface UserDao{
                public function findByToken($token);
            }

        UserDaoMysql.php
            require_once 'models/User.php';

            class UserDaoMysql implements UserDao{
                private $pdo;
                public function __construct(PDO $driver) {
                    $this->pdo = $driver;
                }
                public function findByToken($token){
                }
            }

    #7: Detectando Login (2/2)
    #8: Página de Login (1/2)
    #9: Página de Login (2/2)
    
    #10: Página de Cadastro (1/3)
    #11: Página de Cadastro (2/3)
    #12: Página de Cadastro (3/3)
    #13: Página de Logout + Bug no Login
    #14: Refatorando o Auth
    #15: Estruturando Template (1/2)
    #16: Estruturando Template (2/2)
    #17: Corrigindo erro de clique
    #18: Página Home (1/5)
    #19: Feed Editor (1/2)
    #20: Feed Editor (2/2) // campo para mandar um post

    #21: Página Home (2/5) // exibir o feed na tela
    #22: Página Home (3/5)
    #23: Página Home (4/5)
    #24: Página Home (5/5)
    #25: Perfil (1/6)
    #26: Perfil (2/6)
    #27: Perfil (3/6)
        $userList[] = $id_user; pulo do gato no following


    #28: Perfil (4/6)
    #29: Perfil (5/6)
    #30: Perfil (6/6)
    #31: Corrigindo erro da HOME
    #32: Página amigos
    #33: Página Fotos
    #34: Busca (1/2) // por enquanto buscando apenas users
    #35: Busca (2/2) 

        $sql = $this->pdo->prepare("SELECT * FROM users 
        WHERE name LIKE :name");
        $sql->bindValue(':name', '%'.$name.'%');
        $sql->execute();

        if($sql->rowCount() > 0 ){
            $data = $sql->fetchAll(PDO::FETCH_ASSOC);
            foreach ($data as $item) {
                $array[] = $this->generateUser($item);
            }
        }
        
    #36: Configurações (1/6) // montando a tela
    #37: Configurações (2/6)
        
        script src="https://unpkg.com/imask">/script
        script>
            IMask(
                document.getElementById('birthdate'),
                {mask:'00/00/0000'}
            );
        /script


        ?php if($userInfo->cover): ?>
            img class="mini" src="<?=$base;?>/media/covers/<?=$userInfo->cover;?>" alt=""
        ?php endif; ?>

    #38: Configurações (3/6) 
        if ( $userInfo->email != $email ) {
            if ( $userDao->findByEmail($email) === false ) {
                
                $userInfo->email = $email;

            } else {
                $_SESSION['flash'] = 'Email já existe';
                header('Location: '.$base.'/configuracoes.php');
                exit;
            }
        }
        
    #39: Configurações (4/6)

        if ( !empty( $password ) ) {
            if ( $password_confirmation === $password ) {
                
                $hash = password_hash($password, PASSWORD_DEFAULT);
                $userInfo->password = $hash;

            } else {
                $_SESSION['flash'] = 'As senhas estão diferentes';
                header('Location: '.$base.'/configuracoes.php');
                exit;
            }
        }

        <?php if(!empty($_SESSION['flash'])): ?>
            <?=$_SESSION['flash'];?>
            <?php $_SESSION['flash'] = '';?>
        <?php endif; ?>

        
    #40: Configurações (5/6)
    
        if ( isset($_FILES['avatar']) && !empty($_FILES['avatar']['tmp_name']) ) {
            
    #41: Configurações (6/6)

        //  COVER
        if ( isset($_FILES['cover']) && !empty($_FILES['cover']['tmp_name']) ) {
            
            $newCover = $_FILES['cover'];

            if ( in_array( $newCover['type'], ['image/jpeg', 'image/jpg', 'image/png'] ) ) {
                $coverWidth = 850;
                $coverHeight = 310;

                list($widthOrig, $heightOrig) = getimagesize($newCover['tmp_name']);
                $ratio = $widthOrig / $heightOrig;

                $newWidth = $coverWidth;
                $newHeight = $newWidth / $ratio;

                if ($newHeight < $coverHeight) {
                    $newHeight = $coverHeight;
                    $newWidth = $newHeight * $ratio;
                }

                // echo $newWidth.' x '.$newHeight;
                // exit;

                $x = $coverWidth - $newWidth;
                $y = $coverHeight - $newHeight;
                $x = $x < 0 ? $x / 2 : $x;
                $y = $y < 0 ? $y / 2 : $y;

                // echo $x.' x '.$y;
                // exit;

                $finalImage = imagecreatetruecolor($coverWidth, $coverHeight);
                switch ($newCover['type']) {
                    case 'image/jpeg':
                    case 'image/jpg':
                        $image = imagecreatefromjpeg($newCover['tmp_name']);
                        break;
                    case 'image/png':
                        $image = imagecreatefrompng($newCover['tmp_name']);
                        break;
                }

                imagecopyresampled(
                    $finalImage, $image,
                    $x, $y, 0, 0,
                    $newWidth, $newHeight, $widthOrig, $heightOrig
                );

                $coverName = md5(time().rand(0, 9999).'.jpg');

                imagejpeg($finalImage, './media/covers/'.$coverName, 100);

                $userInfo->cover = $coverName;
            }
        }

        $userDao->update($userInfo);

    #42: Função Like (1/4) 

        // 26/06/2022 domingo
        não recarregar a página: ajax
        $newPost->likeCount = $postLikeDao->getLikeCount($newPost->id);

        ---

        Postlike.php
        ---
        class Postlike{
            private $id;
            private $id_post;
            private $id_user;
            private $created_at;
        }

        interface PostLikeDao{
            public function getLikeCount($id_post);
            public function isLiked($id_post, $id_user);
            public function likeToggle($id_post, $id_user);
        }

        
        PostLikeDaoMysql.php 
        ---
        ?php
        require_once './models/Postlike.php';

        class PostLikeDaoMysql implements PostLikeDao{

            private $pdo;

            public function __construct(PDO $driver) {
                $this->pdo = $driver;
            }

            public function getLikeCount($id_post){
                $sql = $this->pdo->prepare("SELECT COUNT(*) as c FROM postlikes 
                WHERE id_post = :id_post");
                $sql->bindValue(":id_post", $id_post);
                $sql->execute();
                
                $data = $sql->fetch();
                return $data['c'];
                
            }

    #43: Função Like (2/4)

        $newPost->liked = $postLikeDao->isLiked($newPost->id, $id_user);

    #44: Função Like (3/4)

        txt com ajax aula Função Like (3.4).zip
        
    #45: Função Like (4/4)
    #46: Função Comentário (1/3)

            model/PostComment.php
                interface PostCommentDao {}
            dao/PostCommentDaoMysql.php
                PostCommentDaoMysql implements PostCommentDao {
                    private $pdo;

                    public function getComments($id_post){}
                    public function addComments(PostComment $pc){}
                }
                
    #47: Função Comentário (2/3)

        if ($sql->rowCount() > 0) {
            $data = $sql->fetchAll(PDO::FETCH_ASSOC);

            $userDao = new UserDaoMysql($this->pdo);

            foreach ($data as $item ) {
                $commentItem = new PostComment();
                $commentItem->id = $item['id'];
                $commentItem->id_post = $item['id_post'];
                $commentItem->id_user = $item['id_user'];
                $commentItem->created_at = $item['created_at'];
                $commentItem->body = $item['body'];
                $commentItem->user = $userDao->findById($item['id_user']);

                $array[] = $commentItem;
            }
        }
        return $array;

    #48: Função Comentário (3/3)
        
        correção no feed-item-script.php

            let data = new FormData();
            data.append('id', id);
            data.append('txt', txt);

            let req = await fetch('ajax_comment.php', {
                method: 'POST',
                body: data
            });

    #49: Seguir (1/2)

        dao/UserRelation.php 
            interface UserRelationDao {}
        model/UserRelationDaoMysql.php
            class UserRelationDaoMysql implements UserRelationDao {}

    #50: Seguir (2/2)
    #51: Upload de foto (1/4)
        Upload de foto (1/4).zip
        
    #52: Upload de foto (2/4)
    #53: Upload de foto (3/4)
    #54: Upload de foto (4/4)
    #55: Detalhes do Feed (1/2)
    #56: Detalhes do Feed (2/2)
    #57: Deletando tudo dos posts
    #58: Paginação da Home (1/2)
    #59: Paginação da Home (2/2)
    #60: Paginação do Perfil
    #61: Refatorando Paginação
    #62: Bug do Like no Perfil
    #63: Bug do Banner
</pre>
</body>
</html>